<?php
/**
 * @file
 *
 * Experiments with Drupal forms.
 */

function form_experiments_menu() {
  $items = array();

  $items['form-experiments'] = array(
    'title' => t('Form Experiments'),
    'page callback' => 'form_experiments_view',
    'access callback' => TRUE,
    'description' => t('Form Experiments'),
    'type' => MENU_CALLBACK,
  );

  $items['form-experiments/01'] = array(
    'title' => t('Form Experiments 01'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('form_experiments_01'),
    'access callback' => TRUE,
    'description' => t('Form Experiments 01'),
    'type' => MENU_CALLBACK,
  );

  $items['form-experiments/02'] = array(
    'title' => t('Form Experiments 02'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('form_experiments_02'),
    'access callback' => TRUE,
    'description' => t('Form Experiments 02'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

function form_experiments_view() {
  return "Hello World";
}

//function form_experiments_fix_duplicate_id($element) {
//  if ($element['#id'] === $element['upload']['#id']) {
//    $element['#id'] = drupal_html_id($element['#id']);
//  }
//  return $element;
//}

function form_experiments_01() {
  $form['#attached']['js'] = array(
    drupal_get_path('module', 'form_experiments') . '/js/form_experiments.js',
  );

  $form['managed_files'] = array(
    '#type' => 'fieldset',
    '#title' => t('Managed Files'),
  );

  $num_docs = 3;
  for ($i = 1; $i <= $num_docs; $i++) {
    $form['managed_files'][$i] = array(
      '#type' => 'managed_file',
      '#title' => 'Managed File ' . $i,
    );
  }

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit',
  );

  return $form;
}

function form_experiments_02($form, & $form_state) {

  $form['image-fieldset'] = array(
    '#prefix' => '<div id="image-fieldset">',
    '#suffix' => '</div>',
  );

  $form['image-fieldset']['image'] = array(
    '#markup' => '',
  );

  $form['image-fieldset']['file'] = array(
    '#type' => 'file',
  );

  $form['image-fieldset']['action'] = array(
    '#type' => 'submit',
    '#value' => 'upload',
    '#submit' => array('upload_image'),
    '#ajax' => array(
      'callback' => 'upload_image',
      'wrapper' => 'image-fieldset',
      'method' => 'replace',
      'effect' => 'fade',
    ),
  );

  return $form;
}

function upload_image($form, $form_state) {
  $file = file_save_upload('file', array('file_validate_extensions' => array('png gif jpg jpeg')), "public://", $replace = FILE_EXISTS_REPLACE);

  if ($file) {
    $file->status = FILE_STATUS_PERMANENT;
    file_save($file);
    $form['image-fieldset'] = array(
      '#prefix' => '<div id="image-fieldset">',
      '#suffix' => '</div>',
    );

    $form['image-fieldset']['image'] = array(
      '#markup' => '<div>'. t('Preview:') . '</div><img src="/sites/default/files/' . $file->filename . '" height="250" />',
    );

    $form['image-fieldset']['file'] = array(
      '#markup' => '<div>' . $file->filename . '</div>',
    );

    $form['image-fieldset']['action'] = array(
      '#type' => 'submit',
      '#value' => 'remove',
      '#submit' => array('remove_image'),
      '#ajax' => array(
        'callback' => 'remove_image',
        'wrapper' => 'image-fieldset',
        'method' => 'replace',
        'effect' => 'fade',
      ),
    );
  }
  else {
    drupal_set_message('No file uploaded.');
  }

  return $form['image-fieldset'];
}

function remove_image() {
  $form['image-fieldset'] = array(
    '#prefix' => '<div id="image-fieldset">',
    '#suffix' => '</div>',
  );

  $form['image-fieldset']['image'] = array(
    '#markup' => '',
  );

  $form['image-fieldset']['file'] = array(
    '#type' => 'file',
  );

  $form['image-fieldset']['action'] = array(
    '#type' => 'submit',
    '#value' => 'upload',
    '#submit' => array('upload_image'),
    '#ajax' => array(
      'callback' => 'upload_image',
      'wrapper' => 'image-fieldset',
      'method' => 'replace',
      'effect' => 'fade',
    ),
  );
}
